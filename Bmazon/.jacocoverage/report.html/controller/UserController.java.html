<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UserController.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;Bmazon&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">controller</a> &gt; <span class="el_source">UserController.java</span></div><h1>UserController.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package controller;

import APIs.SecurePBKDF2;
import static APIs.SecurePBKDF2.validatePassword;
import APIs.SendEmail;
import entity.Seller;
import entity.User;
import java.io.File;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.PrintWriter;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.NoSuchAlgorithmException;
import java.security.spec.InvalidKeySpecException;
import java.sql.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import model.UserDAO;
import model.DBConnection;
import model.SellerDAO;
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;

/**
 *
 * @author Admin
 */
<span class="nc" id="L46">public class UserController extends HttpServlet {</span>

    /**
     * Processes requests for both HTTP &lt;code&gt;GET&lt;/code&gt; and &lt;code&gt;POST&lt;/code&gt;
     * methods.
     *
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
<span class="nc" id="L57">    DBConnection dbCon = new DBConnection();</span>
<span class="nc" id="L58">    UserDAO daoUser = new UserDAO();</span>
<span class="nc" id="L59">    SellerDAO daoSeller = new SellerDAO();</span>
    private static final long serialVersionUID = 1;

    protected void processRequest(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException, NoSuchAlgorithmException, InvalidKeySpecException {
<span class="nc" id="L64">        response.setContentType(&quot;text/html;charset=UTF-8&quot;);</span>
<span class="nc" id="L65">        try (PrintWriter out = response.getWriter()) {</span>
<span class="nc" id="L66">            String service = request.getParameter(&quot;service&quot;);</span>

<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (service == null) {</span>
<span class="nc" id="L69">                service = &quot;info&quot;;</span>
            }

            //Logout service
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;logout&quot;)) {</span>
<span class="nc" id="L74">                serviceLogout(request, response);</span>
            }

            //change pass
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;changepass&quot;)) {</span>
<span class="nc" id="L79">                serviceChangePassword(request, response);</span>
            }

            //
<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;changepassPage&quot;)) {</span>
<span class="nc" id="L84">                serviceChangePasswordPage(request, response);</span>
            }

            //account page to see profile, security, orders, payments, profile, list
<span class="nc bnc" id="L88" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;account&quot;)) {</span>
<span class="nc" id="L89">                serviceAccount(request, response);</span>
            }

            //profile
<span class="nc bnc" id="L93" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;info&quot;)) {</span>
<span class="nc" id="L94">                serviceInfo(request, response);</span>
            }

            //Edit public profile Service
            //Edit Profile Page
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;editProfile&quot;)) {</span>
<span class="nc" id="L100">                serviceEditProfile(request, response);</span>
            }
            //Change Info Profile
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;changeInfo&quot;)) {</span>
<span class="nc" id="L104">                serviceChangeInfoPublicProfile(request, response);</span>
            }

            //Edit private profile service
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;editPrivateProfile&quot;)) {</span>
<span class="nc" id="L109">                serviceEditPrivateProfile(request, response);</span>
            }
            //Change info
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;changePrivateInfo&quot;)) {</span>
<span class="nc" id="L113">                serviceChangeInfoPrivateProfile(request, response);</span>
            }

            //Upload profile image
<span class="nc bnc" id="L117" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;uploadProfileImage&quot;)) {</span>
<span class="nc" id="L118">                serviceUploadProfileImage(request, response);</span>
            }
            //Update
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;updateProfileImage&quot;)) {</span>
<span class="nc" id="L122">                serviceUpdateProfileImage(request, response);</span>
            }

            //Upload background image
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;uploadBackgroundImage&quot;)) {</span>
<span class="nc" id="L127">                serviceUploadBackgroundImage(request, response);</span>
            }
            //Update
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;updateBackgroundImage&quot;)) {</span>
<span class="nc" id="L131">                serviceUpdateBackgroundImage(request, response);</span>
            }

            //edit wallet
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;editWallet&quot;)) {</span>
<span class="nc" id="L136">                serviceEditWallet(request, response);</span>
            }

            //verify wallet deposit
<span class="nc bnc" id="L140" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;verifyWalletDeposit&quot;)) {</span>
<span class="nc" id="L141">                serviceVerifyWalletDeposit(request, response);</span>
            }
            
            //verify wallet withdrawal
<span class="nc bnc" id="L145" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;verifyWalletWithdrawal&quot;)) {</span>
<span class="nc" id="L146">                serviceVerifyWalletWithdrawal(request, response);</span>
            }

            //deposit wallet
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;deposit&quot;)) {</span>
<span class="nc" id="L151">                serviceDeposit(request, response);</span>
            }

            //withdrawal wallet
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;withdrawal&quot;)) {</span>
<span class="nc" id="L156">                serviceWithdrawal(request, response);</span>
            }

            //Turn on seller feature
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;turnOnSalesFeature&quot;)) {</span>
<span class="nc" id="L161">                serviceTurnOnSalesFeature(request, response);</span>
            }
            //Submit request seller
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;requestSeller&quot;)) {</span>
<span class="nc" id="L165">                serviceSellerRequest(request, response);</span>
            }
            //Denied request
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (service.equalsIgnoreCase(&quot;editDeniedSellerInformation&quot;)) {</span>
<span class="nc" id="L169">                serviceEditDenied(request, response);</span>
            }
<span class="nc bnc" id="L171" title="All 8 branches missed.">        }</span>
<span class="nc" id="L172">    }</span>

    public void serviceLogout(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L175">        request.getSession().invalidate();</span>
<span class="nc" id="L176">        sendDispatcher(request, response, &quot;index.jsp&quot;);</span>
<span class="nc" id="L177">    }</span>

    public void serviceChangePassword(HttpServletRequest request, HttpServletResponse response) throws NoSuchAlgorithmException, InvalidKeySpecException {
<span class="nc" id="L180">        String messChangepass = &quot;&quot;;</span>

<span class="nc" id="L182">        HttpSession session = request.getSession();</span>
<span class="nc" id="L183">        User account = (User) session.getAttribute(&quot;currUser&quot;);</span>

<span class="nc" id="L185">        String user = account.getUsername();</span>
<span class="nc" id="L186">        String oldpass = request.getParameter(&quot;oldpass&quot;);</span>
<span class="nc" id="L187">        String newpass = request.getParameter(&quot;newpass&quot;);</span>
<span class="nc" id="L188">        String repass = request.getParameter(&quot;renewpass&quot;);</span>
<span class="nc" id="L189">        boolean matched = false;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (oldpass != null) {</span>
<span class="nc" id="L191">            matched = validatePassword(oldpass, account.getPassword());</span>
        }
<span class="nc bnc" id="L193" title="All 4 branches missed.">        if (matched == false &amp;&amp; oldpass != null) {</span>
<span class="nc" id="L194">            messChangepass = &quot;Old Password is not correct&quot;;</span>
<span class="nc" id="L195">            request.setAttribute(&quot;oldpassChange&quot;, oldpass);</span>
<span class="nc" id="L196">            request.setAttribute(&quot;newpassChange&quot;, newpass);</span>
<span class="nc" id="L197">            request.setAttribute(&quot;renewpassChange&quot;, repass);</span>
<span class="nc bnc" id="L198" title="All 6 branches missed.">        } else if (matched == true &amp;&amp; oldpass != null &amp;&amp; newpass.equals(repass)) {</span>
<span class="nc" id="L199">            String securePassword = SecurePBKDF2.generateStrongPasswordHash(newpass);</span>
<span class="nc" id="L200">            daoUser.changePassword(user, securePassword);</span>
<span class="nc" id="L201">            messChangepass = &quot;Change password successfully !!&quot;;</span>
        }
<span class="nc" id="L203">        request.setAttribute(&quot;messChangepass&quot;, messChangepass);</span>
<span class="nc" id="L204">        sendDispatcher(request, response, &quot;loginAndSecurity/changepass.jsp&quot;);</span>
//        request.setAttribute(&quot;mess&quot;, mess);
//        sendDispatcher(request, response, &quot;loginAndSecurity/changepass.jsp&quot;);
<span class="nc" id="L207">    }</span>

    public void serviceChangePasswordPage(HttpServletRequest request, HttpServletResponse response) throws NoSuchAlgorithmException, InvalidKeySpecException {
<span class="nc" id="L210">        String messChangepass = &quot;&quot;;</span>

//        HttpSession session = request.getSession();
//        User account = (User) session.getAttribute(&quot;currUser&quot;);
//        String user = account.getUsername();
<span class="nc" id="L215">        request.setAttribute(&quot;messChangepass&quot;, messChangepass);</span>
<span class="nc" id="L216">        sendDispatcher(request, response, &quot;loginAndSecurity/changepass.jsp&quot;);</span>
//        request.setAttribute(&quot;mess&quot;, mess);
//        sendDispatcher(request, response, &quot;loginAndSecurity/changepass.jsp&quot;);
<span class="nc" id="L219">    }</span>

    public void serviceInfo(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L222">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L223">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L224">        sendDispatcher(request, response, &quot;user/profile.jsp&quot;);</span>
<span class="nc" id="L225">    }</span>

    private void serviceEditProfile(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L228">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L229">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L230">        sendDispatcher(request, response, &quot;user/editProfile.jsp&quot;);</span>
<span class="nc" id="L231">    }</span>

    private void serviceChangeInfoPublicProfile(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L234">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L235">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L236">        User u = x;</span>
<span class="nc" id="L237">        u.setPublicName(request.getParameter(&quot;username&quot;));</span>
<span class="nc" id="L238">        u.setBio(request.getParameter(&quot;bio&quot;));</span>
<span class="nc" id="L239">        u.setGender(Integer.parseInt(request.getParameter(&quot;gender&quot;)));</span>
<span class="nc" id="L240">        u.setDOB(Date.valueOf(request.getParameter(&quot;dob&quot;)));</span>
<span class="nc" id="L241">        u.setOccupation(request.getParameter(&quot;occupation&quot;));</span>
<span class="nc" id="L242">        u.setAddress(request.getParameter(&quot;address&quot;));</span>
<span class="nc" id="L243">        u.setFacebook(request.getParameter(&quot;Facebook&quot;));</span>
<span class="nc" id="L244">        u.setInstagram(request.getParameter(&quot;Instagram&quot;));</span>
<span class="nc" id="L245">        u.setTwitter(request.getParameter(&quot;Twitter&quot;));</span>
<span class="nc" id="L246">        u.setYoutube(request.getParameter(&quot;Youtube&quot;));</span>
<span class="nc" id="L247">        daoUser.updatePublicInfo(u);</span>
<span class="nc" id="L248">        System.out.println(daoUser.updateInfoUserByAdmin(u));</span>
<span class="nc" id="L249">        String currentUserID = x.getUserId();</span>
<span class="nc" id="L250">        request.getSession().setAttribute(&quot;currUser&quot;, daoUser.getUserById(currentUserID));</span>
<span class="nc" id="L251">        sendDispatcher(request, response, &quot;UserControllerMap?service=info&quot;);</span>
<span class="nc" id="L252">    }</span>

    private void serviceAccount(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L255">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L256">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L257">        sendDispatcher(request, response, &quot;account.jsp&quot;);</span>
<span class="nc" id="L258">    }</span>

    private void serviceEditPrivateProfile(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L261">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L262">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L263">        sendDispatcher(request, response, &quot;user/editPrivateProfile.jsp&quot;);</span>
<span class="nc" id="L264">    }</span>

    private void serviceChangeInfoPrivateProfile(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L267">        String mess = &quot;&quot;;</span>

<span class="nc" id="L269">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L270">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L271">        String name = request.getParameter(&quot;name&quot;);</span>
<span class="nc" id="L272">        String mail = request.getParameter(&quot;mail&quot;);</span>
<span class="nc" id="L273">        String phone = request.getParameter(&quot;phone&quot;);</span>
<span class="nc" id="L274">        String pass = request.getParameter(&quot;pass&quot;);</span>

<span class="nc bnc" id="L276" title="All 4 branches missed.">        if (daoUser.checkExistMail(mail) &amp;&amp; !mail.equals(x.getEmail())) {</span>
<span class="nc" id="L277">            mess = &quot;This email is already in use by another account&quot;;</span>
<span class="nc" id="L278">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L279">            sendDispatcher(request, response, &quot;user/editPrivateProfile.jsp&quot;);</span>
        }
<span class="nc bnc" id="L281" title="All 4 branches missed.">        if (daoUser.checkExistPhone(phone) &amp;&amp; !phone.equals(x.getPhoneNumber())) {</span>
<span class="nc" id="L282">            mess = &quot;This phone number is already in use by another account&quot;;</span>
<span class="nc" id="L283">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L284">            sendDispatcher(request, response, &quot;user/editPrivateProfile.jsp&quot;);</span>
        }
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (x.getPassword().equals(pass)) {</span>
<span class="nc" id="L287">            User u = x;</span>
<span class="nc" id="L288">            u.setFullname(name);</span>
<span class="nc" id="L289">            u.setEmail(mail);</span>
<span class="nc" id="L290">            u.setPhoneNumber(phone);</span>
<span class="nc" id="L291">            daoUser.updatePrivateInfo(u);</span>
<span class="nc" id="L292">            System.out.println(u.getPassword() + u.getFullname());</span>
<span class="nc" id="L293">            String currentUserID = x.getUserId();</span>
<span class="nc" id="L294">            request.getSession().setAttribute(&quot;currUser&quot;, daoUser.getUserById(currentUserID));</span>
<span class="nc" id="L295">            mess = &quot;Change private information successfully!&quot;;</span>
<span class="nc" id="L296">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L297">            sendDispatcher(request, response, &quot;user/editPrivateProfile.jsp&quot;);</span>
<span class="nc" id="L298">        } else {</span>
<span class="nc" id="L299">            mess = &quot;You must enter the correct password&quot;;</span>
<span class="nc" id="L300">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L301">            sendDispatcher(request, response, &quot;user/editPrivateProfile.jsp&quot;);</span>
        }
<span class="nc" id="L303">    }</span>

    private void serviceUploadProfileImage(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L306">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L307">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L308">        sendDispatcher(request, response, &quot;user/uploadProfileImage.jsp&quot;);</span>
<span class="nc" id="L309">    }</span>

    private void serviceUpdateProfileImage(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L312">        String filename = null;</span>
        // Create a factory for disk-based file items
        try {
<span class="nc" id="L315">            DiskFileItemFactory factory = new DiskFileItemFactory();</span>
<span class="nc" id="L316">            ServletContext servletContext = this.getServletConfig().getServletContext();</span>
<span class="nc" id="L317">            File repository = (File) servletContext.getAttribute(&quot;javax.servlet.context.tempdir&quot;);</span>
<span class="nc" id="L318">            factory.setRepository(repository);</span>
<span class="nc" id="L319">            ServletFileUpload upload = new ServletFileUpload(factory);</span>
<span class="nc" id="L320">            List&lt;FileItem&gt; items = upload.parseRequest(request);</span>
            // Process the uploaded items
<span class="nc" id="L322">            Iterator&lt;FileItem&gt; iter = items.iterator();</span>
<span class="nc" id="L323">            HashMap&lt;String, String&gt; fields = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L325">                FileItem item = iter.next();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                if (item.isFormField()) {</span>
<span class="nc" id="L327">                    fields.put(item.getFieldName(), item.getString());</span>
<span class="nc" id="L328">                    String name = item.getFieldName();</span>
<span class="nc" id="L329">                    String value = item.getString();</span>
<span class="nc" id="L330">                    System.out.println(name + &quot; &quot; + value);</span>
<span class="nc" id="L331">                } else {</span>
<span class="nc" id="L332">                    filename = item.getName();</span>
<span class="nc bnc" id="L333" title="All 4 branches missed.">                    if (filename == null || filename.equals(&quot;&quot;)) {</span>
<span class="nc" id="L334">                        break;</span>
                    } else {
<span class="nc" id="L336">                        Path path = Paths.get(filename);</span>
<span class="nc" id="L337">                        String storePath = servletContext.getRealPath(&quot;/upload&quot;);</span>
<span class="nc" id="L338">                        File uploadFile = new File(storePath + &quot;/&quot; + path.getFileName());</span>
<span class="nc" id="L339">                        item.write(uploadFile);</span>
                    }
                }
<span class="nc" id="L342">            }</span>
<span class="nc" id="L343">        } catch (Exception ex) {</span>
<span class="nc" id="L344">            Logger.getLogger(UserController.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L345">        }</span>
<span class="nc" id="L346">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L347">        x.setProfileImage(filename);</span>
<span class="nc" id="L348">        daoUser.uploadprofileImage(x, filename);</span>
<span class="nc" id="L349">        request.getSession().setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L350">        sendDispatcher(request, response, &quot;UserControllerMap?service=info&quot;);</span>
<span class="nc" id="L351">    }</span>

    private void serviceUploadBackgroundImage(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L354">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L355">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L356">        sendDispatcher(request, response, &quot;user/uploadBackgroundImage.jsp&quot;);</span>
<span class="nc" id="L357">    }</span>

    private void serviceUpdateBackgroundImage(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L360">        String filename = null;</span>
        // Create a factory for disk-based file items
        try {
<span class="nc" id="L363">            DiskFileItemFactory factory = new DiskFileItemFactory();</span>
<span class="nc" id="L364">            ServletContext servletContext = this.getServletConfig().getServletContext();</span>
<span class="nc" id="L365">            File repository = (File) servletContext.getAttribute(&quot;javax.servlet.context.tempdir&quot;);</span>
<span class="nc" id="L366">            factory.setRepository(repository);</span>
<span class="nc" id="L367">            ServletFileUpload upload = new ServletFileUpload(factory);</span>
<span class="nc" id="L368">            List&lt;FileItem&gt; items = upload.parseRequest(request);</span>
            // Process the uploaded items
<span class="nc" id="L370">            Iterator&lt;FileItem&gt; iter = items.iterator();</span>
<span class="nc" id="L371">            HashMap&lt;String, String&gt; fields = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L373">                FileItem item = iter.next();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                if (item.isFormField()) {</span>
<span class="nc" id="L375">                    fields.put(item.getFieldName(), item.getString());</span>
<span class="nc" id="L376">                    String name = item.getFieldName();</span>
<span class="nc" id="L377">                    String value = item.getString();</span>
<span class="nc" id="L378">                    System.out.println(name + &quot; &quot; + value);</span>
<span class="nc" id="L379">                } else {</span>
<span class="nc" id="L380">                    filename = item.getName();</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">                    if (filename == null || filename.equals(&quot;&quot;)) {</span>
<span class="nc" id="L382">                        break;</span>
                    } else {
<span class="nc" id="L384">                        Path path = Paths.get(filename);</span>
<span class="nc" id="L385">                        String storePath = servletContext.getRealPath(&quot;/upload&quot;);</span>
<span class="nc" id="L386">                        File uploadFile = new File(storePath + &quot;/&quot; + path.getFileName());</span>
<span class="nc" id="L387">                        item.write(uploadFile);</span>
                    }
                }
<span class="nc" id="L390">            }</span>
<span class="nc" id="L391">        } catch (Exception ex) {</span>
<span class="nc" id="L392">            Logger.getLogger(UserController.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L393">        }</span>
<span class="nc" id="L394">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L395">        x.setBackgroundImage(filename);</span>
<span class="nc" id="L396">        daoUser.uploadBackgroundImage(x, filename);</span>
<span class="nc" id="L397">        request.getSession().setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L398">        sendDispatcher(request, response, &quot;UserControllerMap?service=info&quot;);</span>
<span class="nc" id="L399">    }</span>

    private void serviceEditWallet(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L402">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L403">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L404">        sendDispatcher(request, response, &quot;user/editWallet.jsp&quot;);</span>
<span class="nc" id="L405">    }</span>

    private void serviceVerifyWalletDeposit(HttpServletRequest request, HttpServletResponse response) {
        // get code user submit
<span class="nc" id="L409">        HttpSession session = request.getSession();</span>
<span class="nc" id="L410">        String verifyCode = request.getParameter(&quot;verifyCode&quot;);</span>
<span class="nc" id="L411">        String mess = &quot;&quot;;</span>

<span class="nc" id="L413">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>

        //get code generated
<span class="nc" id="L416">        String authCode = (String) session.getAttribute(&quot;authcode&quot;);</span>
<span class="nc" id="L417">        double amount = (double) session.getAttribute(&quot;amount&quot;);</span>
        
<span class="nc bnc" id="L419" title="All 2 branches missed.">        if (verifyCode.equals(authCode)) {</span>
<span class="nc" id="L420">            daoUser.depositWalletUser(x, amount);</span>
<span class="nc" id="L421">            request.getSession().setAttribute(&quot;currUser&quot;, daoUser.getUserById(x.getUserId()));</span>
<span class="nc" id="L422">            mess = &quot;Deposit Successfully!&quot;;</span>
<span class="nc" id="L423">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L424">            sendDispatcher(request, response, &quot;UserControllerMap?service=editWallet&quot;);</span>
        } else {
<span class="nc" id="L426">            mess = &quot;Verification code is not right!&quot;;</span>
<span class="nc" id="L427">            request.setAttribute(&quot;verifyCode&quot;, verifyCode);</span>
<span class="nc" id="L428">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L429">            sendDispatcher(request, response, &quot;user/verifyWalletDeposit.jsp&quot;);</span>
        }
<span class="nc" id="L431">    }</span>
    
    private void serviceVerifyWalletWithdrawal(HttpServletRequest request, HttpServletResponse response) {
        // get code user submit
<span class="nc" id="L435">        HttpSession session = request.getSession();</span>
<span class="nc" id="L436">        String verifyCode = request.getParameter(&quot;verifyCode&quot;);</span>
<span class="nc" id="L437">        String mess = &quot;&quot;;</span>

<span class="nc" id="L439">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>

        //get code generated
<span class="nc" id="L442">        String authCode = (String) session.getAttribute(&quot;authcode&quot;);</span>
<span class="nc" id="L443">        double amount = (double) session.getAttribute(&quot;amount&quot;);</span>
        
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (verifyCode.equals(authCode)) {</span>
<span class="nc" id="L446">            daoUser.withdrawalWalletUser(x, amount);</span>
<span class="nc" id="L447">            request.getSession().setAttribute(&quot;currUser&quot;, daoUser.getUserById(x.getUserId()));</span>
<span class="nc" id="L448">            mess = &quot;Withdrawal Successfully!&quot;;</span>
<span class="nc" id="L449">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L450">            sendDispatcher(request, response, &quot;UserControllerMap?service=editWallet&quot;);</span>
        } else {
<span class="nc" id="L452">            mess = &quot;Verification code is not right!&quot;;</span>
<span class="nc" id="L453">            request.setAttribute(&quot;verifyCode&quot;, verifyCode);</span>
<span class="nc" id="L454">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L455">            sendDispatcher(request, response, &quot;user/verifyWalletWithdrawal.jsp&quot;);</span>
        }
<span class="nc" id="L457">    }</span>

    private void serviceDeposit(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L460">        HttpSession session = request.getSession();</span>
<span class="nc" id="L461">        String mess = &quot;&quot;;</span>
<span class="nc" id="L462">        double amount = Double.parseDouble(request.getParameter(&quot;amount&quot;));</span>
<span class="nc" id="L463">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L464">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (amount == 0) {</span>
<span class="nc" id="L466">            mess = &quot;Please input amount more than 0.&quot;;</span>
<span class="nc" id="L467">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L468">            sendDispatcher(request, response, &quot;user/editWallet.jsp&quot;);</span>
        } else {
<span class="nc" id="L470">            String option = &quot;editwallet&quot;;</span>
<span class="nc" id="L471">            SendEmail sm = new SendEmail();</span>
<span class="nc" id="L472">            String code = sm.getRandom();</span>
<span class="nc" id="L473">            sm.sendEmail(x.getUsername(), x.getEmail(), code, option);</span>
<span class="nc" id="L474">            session.setAttribute(&quot;authcode&quot;, code);</span>
<span class="nc" id="L475">            session.setAttribute(&quot;amount&quot;, amount);</span>
<span class="nc" id="L476">            sendDispatcher(request, response, &quot;user/verifyWalletDeposit.jsp&quot;);</span>
        }
<span class="nc" id="L478">    }</span>

    private void serviceWithdrawal(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L481">        HttpSession session = request.getSession();</span>
<span class="nc" id="L482">        String mess = &quot;&quot;;</span>
<span class="nc" id="L483">        double amount = Double.parseDouble(request.getParameter(&quot;amount&quot;));</span>
<span class="nc" id="L484">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L485">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">        if (amount == 0) {</span>
<span class="nc" id="L487">            mess = &quot;Please input amount more than 0.&quot;;</span>
<span class="nc" id="L488">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L489">            sendDispatcher(request, response, &quot;user/editWallet.jsp&quot;);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">        } else if (amount &gt; x.getWallet()) {</span>
<span class="nc" id="L491">            mess = &quot;Your wallet does not have enough money.&quot;;</span>
<span class="nc" id="L492">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L493">            sendDispatcher(request, response, &quot;user/editWallet.jsp&quot;);</span>
        } else {
<span class="nc" id="L495">            String option = &quot;editwallet&quot;;</span>
<span class="nc" id="L496">            SendEmail sm = new SendEmail();</span>
<span class="nc" id="L497">            String code = sm.getRandom();</span>
<span class="nc" id="L498">            sm.sendEmail(x.getUsername(), x.getEmail(), code, option);</span>
<span class="nc" id="L499">            session.setAttribute(&quot;authcode&quot;, code);</span>
<span class="nc" id="L500">            session.setAttribute(&quot;amount&quot;, amount);</span>
<span class="nc" id="L501">            sendDispatcher(request, response, &quot;user/verifyWalletWithdrawal.jsp&quot;);</span>
        }
<span class="nc" id="L503">    }</span>

    private void serviceTurnOnSalesFeature(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L506">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L507">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L508">        sendDispatcher(request, response, &quot;user/sellerRequest.jsp&quot;);</span>
<span class="nc" id="L509">    }</span>

    private void serviceSellerRequest(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L512">        String mess = &quot;&quot;;</span>

<span class="nc" id="L514">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L515">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L516">        int userID = Integer.parseInt(x.getUserId());</span>
<span class="nc" id="L517">        String shopName = request.getParameter(&quot;shopName&quot;);</span>
<span class="nc" id="L518">        String sellerPhone = request.getParameter(&quot;sellerPhone&quot;);</span>
<span class="nc" id="L519">        String evidence = request.getParameter(&quot;evidence&quot;);</span>
<span class="nc" id="L520">        int sellerMainProduct = Integer.parseInt(request.getParameter(&quot;sellerMainProduct&quot;));</span>

<span class="nc" id="L522">        boolean isExist = false;</span>

<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (daoSeller.checkExistPhone(sellerPhone)) {</span>
<span class="nc" id="L525">            isExist = true;</span>
<span class="nc" id="L526">            mess = &quot;This phone number is already in use by another account&quot;;</span>
<span class="nc" id="L527">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L528">            sendDispatcher(request, response, &quot;UserControllerMap?service=turnOnSalesFeature&quot;);</span>
        }

<span class="nc bnc" id="L531" title="All 2 branches missed.">        if (daoSeller.checkExistUserID(userID)) {</span>
<span class="nc" id="L532">            isExist = true;</span>
<span class="nc" id="L533">            mess = &quot;You are already request sales feature.&quot;;</span>
<span class="nc" id="L534">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L535">            sendDispatcher(request, response, &quot;UserControllerMap?service=turnOnSalesFeature&quot;);</span>
        }

<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (isExist == false) {</span>
<span class="nc" id="L539">            int verification = 0;</span>
<span class="nc" id="L540">            Seller sel = new Seller(userID, shopName, sellerPhone, evidence, sellerMainProduct, &quot;&quot;, verification);</span>
<span class="nc" id="L541">            daoSeller.addSeler(sel);</span>
<span class="nc" id="L542">            mess = &quot;Waiting for adminstrator to verify your registration certificate...&quot;;</span>
<span class="nc" id="L543">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L544">            sendDispatcher(request, response, &quot;UserControllerMap?service=turnOnSalesFeature&quot;);</span>
        }
<span class="nc" id="L546">    }</span>

    private void serviceEditDenied(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L549">        String mess = &quot;&quot;;</span>

<span class="nc" id="L551">        User x = (User) request.getSession().getAttribute(&quot;currUser&quot;);</span>
<span class="nc" id="L552">        request.setAttribute(&quot;currUser&quot;, x);</span>
<span class="nc" id="L553">        Seller seller = daoSeller.getSellerByUserID(Integer.parseInt(x.getUserId()));</span>

<span class="nc" id="L555">        String shopName = request.getParameter(&quot;shopName&quot;);</span>
<span class="nc" id="L556">        String sellerPhone = request.getParameter(&quot;sellerPhone&quot;);</span>
<span class="nc" id="L557">        String evidence = request.getParameter(&quot;evidence&quot;);</span>
<span class="nc" id="L558">        int sellerMainProduct = Integer.parseInt(request.getParameter(&quot;sellerMainProduct&quot;));</span>

<span class="nc" id="L560">        boolean isExist = false;</span>

<span class="nc bnc" id="L562" title="All 4 branches missed.">        if (daoSeller.checkExistPhone(sellerPhone) &amp;&amp; !sellerPhone.equalsIgnoreCase(seller.getSellerPhone())) {</span>
<span class="nc" id="L563">            isExist = true;</span>
<span class="nc" id="L564">            mess = &quot;This phone number is already in use by another account&quot;;</span>
<span class="nc" id="L565">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L566">            sendDispatcher(request, response, &quot;UserControllerMap?service=turnOnSalesFeature&quot;);</span>
        }

<span class="nc bnc" id="L569" title="All 2 branches missed.">        if (isExist == false) {</span>
<span class="nc" id="L570">            seller.setSellerShopName(shopName);</span>
<span class="nc" id="L571">            seller.setSellerPhone(sellerPhone);</span>
<span class="nc" id="L572">            seller.setEvidence(evidence);</span>
<span class="nc" id="L573">            seller.setSellerMainProduct(sellerMainProduct);</span>
<span class="nc" id="L574">            seller.setSellerVerification(0);</span>
<span class="nc" id="L575">            daoSeller.editSeller(seller);</span>
<span class="nc" id="L576">            mess = &quot;Update successfully!&quot;;</span>
<span class="nc" id="L577">            request.setAttribute(&quot;mess&quot;, mess);</span>
<span class="nc" id="L578">            sendDispatcher(request, response, &quot;UserControllerMap?service=turnOnSalesFeature&quot;);</span>
        }
<span class="nc" id="L580">    }</span>

    public void sendDispatcher(HttpServletRequest request, HttpServletResponse response, String path) {
        try {
<span class="nc" id="L584">            RequestDispatcher rd = request.getRequestDispatcher(path);</span>
<span class="nc" id="L585">            rd.forward(request, response);</span>

<span class="nc" id="L587">        } catch (ServletException | IOException ex) {</span>
<span class="nc" id="L588">            Logger.getLogger(UserController.class</span>
<span class="nc" id="L589">                    .getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L590">        }</span>
<span class="nc" id="L591">    }</span>

    public void sendDispatcherInclude(HttpServletRequest request, HttpServletResponse response, String path) {
        try {
<span class="nc" id="L595">            RequestDispatcher rd = request.getRequestDispatcher(path);</span>
<span class="nc" id="L596">            rd.include(request, response);</span>

<span class="nc" id="L598">        } catch (ServletException | IOException ex) {</span>
<span class="nc" id="L599">            Logger.getLogger(UserController.class</span>
<span class="nc" id="L600">                    .getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L601">        }</span>
<span class="nc" id="L602">    }</span>

    private void writeObject(ObjectOutputStream stream)
            throws IOException {
<span class="nc" id="L606">        stream.defaultWriteObject();</span>
<span class="nc" id="L607">    }</span>

    private void readObject(ObjectInputStream stream)
            throws IOException, ClassNotFoundException {
<span class="nc" id="L611">        stream.defaultReadObject();</span>
<span class="nc" id="L612">    }</span>

    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;HttpServlet methods. Click on the + sign on the left to edit the code.&quot;&gt;
    /**
     * Handles the HTTP &lt;code&gt;GET&lt;/code&gt; method.
     *
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        try {
<span class="nc" id="L627">            processRequest(request, response);</span>
<span class="nc" id="L628">        } catch (NoSuchAlgorithmException | InvalidKeySpecException ex) {</span>
<span class="nc" id="L629">            Logger.getLogger(UserController.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L630">        }</span>
<span class="nc" id="L631">    }</span>

    /**
     * Handles the HTTP &lt;code&gt;POST&lt;/code&gt; method.
     *
     * @param request servlet request
     * @param response servlet response
     * @throws ServletException if a servlet-specific error occurs
     * @throws IOException if an I/O error occurs
     */
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        try {
<span class="nc" id="L645">            processRequest(request, response);</span>
<span class="nc" id="L646">        } catch (NoSuchAlgorithmException | InvalidKeySpecException ex) {</span>
<span class="nc" id="L647">            Logger.getLogger(UserController.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L648">        }</span>
<span class="nc" id="L649">    }</span>

    /**
     * Returns a short description of the servlet.
     *
     * @return a String containing servlet description
     */
    @Override
    public String getServletInfo() {
<span class="nc" id="L658">        return &quot;Short description&quot;;</span>
    }// &lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>